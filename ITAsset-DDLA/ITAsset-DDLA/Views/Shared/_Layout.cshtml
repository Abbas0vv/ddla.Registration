@using ITAsset_DDLA.Helpers
@using Microsoft.AspNetCore.Identity
@using ddla.ITApplication.Database.Models.DomainModels.Account
@inject UserManager<ddlaUser> UserManager
@{
    var user = await UserManager.GetUserAsync(User);
    var isAdmin = User.IsInRole("Admin") || User.IsInRole("SuperAdmin");
}
<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDLA - IT Qeydiyyat Sistemi</title>
    <link rel="icon" type="image/png" href="~/assets/images/ddlaLogo.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Özəl CSS fayllarınız -->
    <link rel="stylesheet" href="~/assets/css/sidebar.css">
    <link rel="stylesheet" href="~/assets/css/edit_add.css">
    <link rel="stylesheet" href="~/assets/css/table.css">
    <link rel="stylesheet" href="~/assets/css/warehouseStyle.css">
</head>
<body>
    <!-- Mobile toggle button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Overlay for mobile -->
    <div class="overlay" id="overlay"></div>

    <div class="sidebar" id="sidebar">
        <a asp-action="Index" asp-controller="Home" style="text-decoration:none; color:#ecf0f1;">
            <div class="sidebar-header">
                <h3>
                    IT Məhsul <br>
                    Qeydiyyat Sistemi
                </h3>
            </div>
        </a>
        <ul class="sidebar-menu">
            <!-- Əsas keçidlər -->
            <li class="@Html.IsActive("Transfer", "Index", "Update", "CreateBlank")">
                <a asp-action="Index" asp-controller="Transfer">
                    <i class="fas fa-tachometer-alt"></i> <span>Təhvil-Təslim Jurnalı</span>
                </a>
            </li>
            <li class="@Html.IsActive("Warehouse", "Index", "Create", "Update", "Detail")">
                <a asp-action="Index" asp-controller="Warehouse">
                    <i class="fas fa-warehouse"></i> <span>Anbar</span>
                </a>
            </li>

            <li class="@Html.IsActive("Equipment", "Index")">
                <a asp-action="Index" asp-controller="Equipment">
                    <i class="fas fa-laptop"></i> <span>Avadanlıqlar</span>
                </a>
            </li>
            <li class="@Html.IsActive("Users", "Index")">
                <a asp-action="Index" asp-controller="Users">
                    <i class="fas fa-users"></i> <span>İstifadəçilər</span>
                </a>
            </li>

            <!-- Daha çoxu / More Dropdown -->
            <li class="dropdown">
                <a href="#" class="dropdown-toggle" id="moreDropdown">
                    <i class="fas fa-ellipsis-h"></i> <span>Daha çoxu...</span>
                </a>
            </li>
        </ul>

        <!-- Flyout panel -->
        <div class="flyout-menu" id="moreFlyout">
            <ul>
                <li class="@Html.IsActive("Settings", "UpdateProfile", "ChangePassword")">
                    <a asp-action="UpdateProfile" asp-controller="Settings">Parametrlər</a>
                </li>
                <li class="@Html.IsActive("Statistics", "Index")">
                    <a asp-action="Index" asp-controller="Statistics">Statistika</a>
                </li>
                @if (isAdmin)
                {
                    <li class="@Html.IsActive("Permission", "Index", "Edit")">
                        <a asp-action="Index" asp-controller="Permission">İdarəetmə</a>
                    </li>
                    <li class="@Html.IsActive("ActivityLogs", "Index")">
                        <a asp-action="Index" asp-controller="ActivityLogs">Loglar</a>
                    </li>
                }
            </ul>
        </div>

        <!-- Sidebar altında istifadəçi məlumatları və çıxış -->
        <div class="sidebar-footer">
            @if (User.Identity.IsAuthenticated && user != null)
            {
                <div class="user-info">
                    <div class="user-avatar" title="@User.Identity.Name">
                        @if (!string.IsNullOrEmpty(user.ProfilePictureUrl))
                        {
                            <img src="~/assets/images/Uploads/ProfilePictures/@Url.Content(user.ProfilePictureUrl)" alt="Profile Picture" class="profile-picture" loading="lazy" />
                        }
                        else
                        {
                            @User.Identity.Name.Substring(0, 1).ToUpper()
                        }
                    </div>
                    <span class="user-name" title="@User.Identity.Name">@User.Identity.Name</span>
                </div>
                <a asp-action="LogOut" asp-controller="Account" class="btn btn-outline-light btn-sm w-100 mt-2">
                    <i class="fas fa-sign-out-alt"></i> Çıxış
                </a>
            }
        </div>
    </div>

    <div class="main-content" id="mainContent">
        @RenderBody()
    </div>

    <script>
        // Toggle flyout menu
        document.getElementById('moreDropdown').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('moreFlyout').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        });

        // Toggle sidebar on mobile
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        });

        // Close flyout when clicking outside
        document.getElementById('overlay').addEventListener('click', function() {
            document.getElementById('moreFlyout').classList.remove('open');
            document.getElementById('sidebar').classList.remove('open');
            this.classList.remove('active');
        });

        // Close flyout when clicking on a link
        document.querySelectorAll('.flyout-menu a').forEach(function(link) {
            link.addEventListener('click', function() {
                document.getElementById('moreFlyout').classList.remove('open');
                document.getElementById('overlay').classList.remove('active');
            });
        });

        // Close flyout when pressing Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.getElementById('moreFlyout').classList.remove('open');
                document.getElementById('overlay').classList.remove('active');
            }
        });

        // Close flyout when clicking on other sidebar items
        document.querySelectorAll('.sidebar-menu li:not(.dropdown) a').forEach(function(item) {
            item.addEventListener('click', function() {
                document.getElementById('moreFlyout').classList.remove('open');
                document.getElementById('overlay').classList.remove('active');
            });
        });

        // Handle window resize to ensure proper behavior
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                // On larger screens, ensure sidebar is visible
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('overlay').classList.remove('active');
            }
        });
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>