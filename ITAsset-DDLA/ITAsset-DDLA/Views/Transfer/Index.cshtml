@using ITAsset_DDLA.Helpers.Enums
@using ddla.ITApplication.Database
@using ddla.ITApplication.Helpers

@model List<Transfer>

<div class="container">
    <div class="logo-header">
        <img src="~/assets/images/ddlaLogo.png" alt="DDLA Logo" class="img-fluid">
        <div class="logo-text">
            <h1>Təhvil-Təslim Jurnalı</h1>
            <small>Dövlət Dəniz və Liman Agentliyi</small>
        </div>
    </div>

    <!-- Add this new button section - Replace the existing button section with this -->
    <div class="mb-3 text-end">
        <a asp-action="Create" class="btn btn-primary">
            <i class="fas fa-plus"></i> Yeni Təhvil-Təslim yarat
        </a>
        <a asp-action="CreateBlank" class="btn btn-success ml-2">
            <i class="fas fa-file-alt"></i> Yeni Blank yarat
        </a>
        <a asp-action="ExportProductsToExcel" class="btn btn-success">
            <i class="fas fa-file-excel"></i> Excel-ə çıxar
        </a>
    </div>

    <div class="mb-3">
        <input type="text" id="globalSearch" class="form-control" placeholder="Ümumi axtarış...">
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="productsTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>İmzalanıb</th>
                    <th>İnventar ID</th>
                    <th>İstifadəçi adı</th>
                    <th>Məhsul adı</th>
                    <th>Təsvir</th>
                    <th>Departament/Şöbə</th>
                    <th>Verilmə tarixi</th>
                    <th>Alınma tarixi</th>
                    <th>Fayl</th>
                    <th>Digər</th>
                    <th>Əməliyyatlar</th>
                </tr>
                <tr class="column-filters">
                    <th></th> <!-- # -->
                    <th>
                        <select class="form-control form-control-sm" data-column="1">
                            <option value="">Hamısı</option>
                            <option value="İmzalanıb">İmzalanıb</option>
                            <option value="İmzalanmayıb">İmzalanmayıb</option>
                        </select>
                    </th>
                    <th><input type="text" class="form-control form-control-sm" placeholder="Axtar..." data-column="2"></th>
                    <th><input type="text" class="form-control form-control-sm" placeholder="Axtar..." data-column="3"></th>
                    <th><input type="text" class="form-control form-control-sm" placeholder="Axtar..." data-column="4"></th>
                    <th><input type="text" class="form-control form-control-sm" placeholder="Axtar..." data-column="5"></th>
                    <th><input type="text" class="form-control form-control-sm" placeholder="Axtar..." data-column="6"></th>
                    <th><input type="date" class="form-control form-control-sm" data-column="7"></th>
                    <th><input type="date" class="form-control form-control-sm" data-column="8"></th>
                    <th></th> <!-- Fayl -->
                    <th></th> <!--Digər-->
                    <th></th> <!-- Əməliyyatlar -->
                </tr>
            </thead>
            <tbody>
                @{
                    int counter = 1;
                    foreach (var item in Model)
                    {
                        <tr>
                            <td>@counter</td>
                            <td data-order="@item.IsSigned.ToString().ToLower()">
                                <span class="d-none">@((item.IsSigned ? "İmzalanıb" : "İmzalanmayıb"))</span>
                                @if (item.IsSigned)
                                {
                                    <i class="fas fa-check-circle text-success" title="İmzalanıb"></i>
                                }
                                else
                                {
                                    <i class="fas fa-times-circle text-danger" title="İmzalanmayıb"></i>
                                }
                            </td>

                            <td>@item.InventarId</td>
                            <td>@item.Recipient</td>
                            <td>@item.Name</td>
                            <td>@item.Description</td>
                            <td>
                                @{
                                    var parts = item.DepartmentSection?.Split(',');
                                    var sectionName = parts != null && parts.Length > 1 ? parts[1].Trim() : item.DepartmentSection;
                                }
                                @sectionName
                            </td>

                            <td data-order="@item.DateofIssue.ToString("yyyy-MM-dd HH:mm")">
                                <span class="d-none">@item.DateofIssue.ToString("dd.MM.yyyy")</span>
                                @item.DateofIssue.ToString("dd.MM.yyyy HH:mm")
                            </td>
                            <td data-order="@(item.DateofReceipt?.ToString("yyyy-MM-dd HH:mm") ?? "")">
                                @if (item.DateofReceipt.HasValue)
                                {
                                    <span class="d-none">@item.DateofReceipt.Value.ToString("dd.MM.yyyy")</span>
                                    @item.DateofReceipt.Value.ToString("dd.MM.yyyy HH:mm")
                                }
                                else
                                {
                                    <span class="d-none">Təhvil alınmayıb</span>
                                    <span>Təhvil alınmayıb</span>
                                }
                            </td>
                            <td>
                                <a asp-action="GenerateHandoverPdf" asp-route-id="@item.Id" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-download"></i>
                                </a>
                            </td>
                            <td>
                                <button type="button"
                                        class="btn btn-outline-secondary btn-sm btn-view-acts"
                                        data-id="@item.Id"
                                        data-file="@item.FilePath"
                                        data-signed="@item.SignedFilePath"
                                        data-returned="@item.ReturnedFilePath">
                                    <i class="fas fa-eye"></i>
                                </button>

                            </td>
                            <td>
                                <a asp-action="Update" asp-route-id="@item.Id" class="btn btn-warning btn-sm">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-danger btn-sm">
                                    <i class="fas fa-trash"></i>
                                </a>

                                @if (!item.IsSigned)
                                {
                                    <a asp-action="AddFiles" asp-controller="Warehouse" asp-route-id="@item.StockProductId"
                                       class="btn btn-sm btn-outline-danger mt-1" tabindex="-1" aria-disabled="true">
                                        İmzalanmayıb
                                    </a>
                                }
                                else
                                {
                                    if (item.TransferStatus != TransferAction.Returned)
                                    {
                                        <a asp-action="AddFiles" asp-controller="Warehouse" asp-route-id="@item.StockProductId"
                                           class="btn btn-outline-info btn-sm mt-1">
                                            <i class="fas fa-undo"></i> Qaytar
                                        </a>
                                    }
                                    else
                                    {
                                        <a asp-action="AddFiles" asp-controller="Warehouse" asp-route-id="@item.StockProductId"
                                           class="badge bg-success">
                                            <i class="fas fa-undo"></i> Qaytarılıb
                                        </a>
                                    }
                                }

                            </td>
                        </tr>
                        counter++;
                    }
                }
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade" id="viewActsModal" tabindex="-1" aria-labelledby="viewActsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header text-white" style="background-color:#003366;">
                <h5 class="modal-title" id="viewActsModalLabel">Məhsulun aktları</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Bağla"></button>
            </div>
            <div class="modal-body">
                <div id="actsContent">
                    <p class="text-center text-muted">Məlumat yüklənir...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Bağla</button>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js"></script>

<script>
    $(document).ready(function() {
        const table = $('#productsTable').DataTable({
            dom: 't',
            ordering: false,
            info: false,
            paging: false,
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/az-AZ.json'
            }
        });

        $('#globalSearch').on('keyup', function() {
            table.search(this.value).draw();
        });

        $('#productsTable thead select[data-column="1"]').on('change', function() {
            const val = $(this).val();
            table.column(1).search(val).draw();
        });

        $('#productsTable thead input').on('keyup change', function() {
            const colIndex = $(this).data('column');
            table.column(colIndex).search(this.value).draw();
        });

        $('.datepicker').datepicker({
            format: 'dd.mm.yyyy',
            autoclose: true
        }).on('changeDate', function(e) {
            table.draw();
        });

        $('#productsTable thead select[data-column="6"]').on('change', function() {
            const val = $(this).val();
            table.column(6).search(val ? "^" + val + "$" : "", true, false).draw();
        });

        $('#productsTable thead select[data-column="7"]').on('change', function() {
            const val = $(this).val();
            table.column(7).search(val ? "^" + val + "$" : "", true, false).draw();
        });

        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
            const dateIssueFilter = $('input[data-column="8"]').val();
            const dateIssueStr = $(table.row(dataIndex).node()).find('td').eq(8).find('span.d-none').text();
            if (dateIssueFilter) {
                const partsFilter = dateIssueFilter.split('.');
                const partsCell = dateIssueStr.split('.');
                const filterDate = new Date(partsFilter[2], partsFilter[1]-1, partsFilter[0]);
                const cellDate = new Date(partsCell[2], partsCell[1]-1, partsCell[0]);
                if (cellDate.getTime() !== filterDate.getTime()) return false;
            }

            const dateReceiptFilter = $('input[data-column="9"]').val();
            const dateReceiptStr = $(table.row(dataIndex).node()).find('td').eq(9).find('span.d-none').text();
            if (dateReceiptFilter) {
                const partsFilter = dateReceiptFilter.split('.');
                const partsCell = dateReceiptStr.split('.');
                const filterDate = new Date(partsFilter[2], partsFilter[1]-1, partsFilter[0]);
                const cellDate = new Date(partsCell[2], partsCell[1]-1, partsCell[0]);
                if (cellDate.getTime() !== filterDate.getTime()) return false;
            }

            return true;
        });
    });
    // 🔸 Göz düyməsinə klik - modal açılması
    $(document).on('click', '.btn-view-acts', function () {
        const signed = $(this).data('signed');
        const returned = $(this).data('returned');

        let html = '<ul class="list-group">';

        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    İmzalanmış akt
                    ${signed
                        ? `<a href="${signed}" download class="btn btn-sm btn-outline-success">
                             <i class="fas fa-download"></i> Yüklə
                           </a>`
                        : `<span class="badge bg-secondary">Yoxdur</span>`}
                 </li>`;

        html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    Qaytarılma aktı
                    ${returned
                        ? `<a href="${returned}" download class="btn btn-sm btn-outline-info">
                             <i class="fas fa-download"></i> Yüklə
                           </a>`
                        : `<span class="badge bg-secondary">Yoxdur</span>`}
                 </li>`;

        html += '</ul>';

        $('#actsContent').html(html);
        $('#viewActsModal').modal('show');
    });

</script>
