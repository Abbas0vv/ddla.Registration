@using ITAsset_DDLA.Database.Models.ViewModels.Admin
@model EditPermissionsViewModel

@{
    ViewData["Title"] = "İcazələri Redaktə Et";
}
<div class="main-content">
    <div class="container py-4">
        <div class="card border-0 shadow rounded-3">
            <div class="card-body text-center border-bottom pb-4 bg-light">
                <img src="~/assets/images/Uploads/ProfilePictures/@(string.IsNullOrEmpty(Model?.ProfilePictureUrl) ? "default.jpg" : Model.ProfilePictureUrl)"
                     alt="Profile Picture"
                     class="rounded-circle mb-2 border"
                     style="width:90px; height:90px; object-fit:cover;">
                <h4 class="mb-0">@Model?.FullName</h4>
                <small class="text-muted">@Model?.Username</small>
            </div>

            @if (Model == null)
            {
                <div class="alert alert-danger m-3">İstifadəçi məlumatları yüklənərkən xəta baş verdi</div>
            }
            else
            {
                <form asp-action="Edit" method="post" id="permissionsForm" class="p-4">
                    <input type="hidden" asp-for="UserId" />

                    @{
                        int permissionIndex = 0;
                    }

                    @foreach (var group in Model.PermissionGroups)
                    {
                        <div class="mb-4 border rounded-3 overflow-hidden">
                            <div class="bg-secondary text-white p-2 fw-semibold">
                                @group.GroupName
                            </div>
                            <div class="row p-3">
                                @foreach (var permission in group.Permissions)
                                {
                                    <div class="col-md-6 mb-3">
                                        <div class="d-flex align-items-center border rounded p-2 transition-bg @(permission.HasPermission ? "bg-yes" : "bg-no")">
                                            <input type="hidden"
                                                   name="Permissions[@permissionIndex].Type"
                                                   value="@permission.Type" />
                                            <div class="form-check form-switch m-0">
                                                <input class="form-check-input permission-checkbox"
                                                       type="checkbox"
                                                       name="Permissions[@permissionIndex].IsSelected"
                                                       id="permission-@permission.Type"
                                                       value="true"
                                                       @(permission.HasPermission ? "checked" : "")>
                                            </div>
                                            <label class="ms-2 mb-0" for="permission-@permission.Type">
                                                @permission.Description
                                            </label>
                                        </div>
                                    </div>
                                    permissionIndex++;
                                }
                            </div>
                        </div>
                    }

                    <div class="text-end">
                        <a asp-action="Index" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-arrow-left"></i> Geri Qayıt
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Yadda Saxla
                        </button>
                    </div>
                </form>
            }
        </div>
    </div>
</div>

<style>
    .bg-yes {
        background-color: rgba(var(--bs-secondary-rgb),var(--bs-bg-opacity)) !important;
    }

    .bg-no {
        background-color: rgba(var(--bs-success-rgb), var(--bs-bg-opacity)) !important;
    }

    .transition-bg {
        transition: background-color 0.3s ease;
    }

    .form-check-input {
        cursor: pointer;
    }

        .form-check-input:checked {
            background-color: #0b5ed7;
            border-color: #0b5ed7;
        }

    .card {
        background-color: #fff;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.permission-checkbox').forEach(cb => {
            cb.addEventListener('change', function () {
                const parent = this.closest('.d-flex');
                parent.classList.toggle('bg-yes', this.checked);
                parent.classList.toggle('bg-no', !this.checked);
            });
        });

        const form = document.getElementById('permissionsForm');
        if (form) {
            form.addEventListener('submit', function () {
                const btn = this.querySelector('button[type="submit"]');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yadda saxlanılır...';
            });
        }
    });
</script>
